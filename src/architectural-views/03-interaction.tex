\section{Взаимодействие}

\section{Взаимодействия и потоки выполнения}
\label{sec:interactions}

В этом разделе фиксируются ключевые сценарии взаимодействия компонентов вычислительной модели:
поиск и вычисление характеристик, генерация выборки, политика кэширования и точки расширения.

\subsection{Поток вычисления характеристики}

Запрос целевой характеристики (см. UML на рис.~\ref{fig:uml-computation}) обрабатывается стратегией
\texttt{ComputationStrategy} по следующему алгоритму:
\begin{enumerate}
  \item \textbf{Аналитика.} Проверяется наличие \emph{аналитической} реализации \texttt{AnalyticalComputation}
        для требуемого \texttt{target} в экземпляре \texttt{Distribution}.
  \item \textbf{Кэш.} При включённом кэшировании выполняется lookup по ключу, зависящему от:
        (i) идентичности распределения, (ii) имени характеристики, (iii) входных данных и
        (iv) переданных \texttt{**options}. При попадании результат возвращается немедленно.
  \item \textbf{Маршрут.} Если ни аналитики, ни кэша нет, стратегия запрашивает в
        \texttt{DistributionTypeRegister} (рис.~\ref{fig:uml-register}) маршрут
        \texttt{find\_path(source, target)} в графе характеристик для типа данного распределения.
  \item \textbf{Пошаговое вычисление.} По рёбрам маршрута последовательно применяются назначенные
        \texttt{ComputationMethod}-ы. Если для пары узлов определено несколько методов, стратегия может
        выбрать конкретную реализацию на основании \texttt{**options} или внутренних эвристик.
  \item \textbf{Мемоизация.} Итоговое значение сохраняется в кэш согласно политике стратегии и возвращается
        вызывающей стороне.
\end{enumerate}

Инварианты реестра гарантируют существование маршрутов между \emph{definitive}-узлами
и отсутствие обратных рёбер из \emph{indefinitive} в \emph{definitive}, что упрощает выбор валидных путей.

\subsection{Опции вычислений (\texorpdfstring{\texttt{**options}}{**options})}

И \texttt{GenericCharacteristic}, и \texttt{ComputationMethod} принимают дополнительные параметры,
влияющие на вычисление. Пример: инверсия \texttt{cdf}\,$\to$\,\texttt{ppf} с выбором ветви
\texttt{most\_left}/\texttt{most\_right}. Стратегия \emph{может} проигнорировать часть опций,
но пользователь вправе подключить свою \texttt{ComputationStrategy}/\texttt{ComputationMethod},
которые их учитывают. Для предсказуемости результат должен рассматриваться как функция пары
(входные данные, опции).

\subsection{Поток генерации выборки}

Генерация выборки делегируется \texttt{SamplingStrategy}:
\begin{enumerate}
  \item вызывается \texttt{sampling\_strategy.sample(n, distr, **options)};
  \item стратегия по умолчанию генерирует \texttt{n} равномерных вероятностей и применяет к ним \texttt{ppf}
        данного распределения (см. рис.~\ref{fig:uml-distributions});
  \item результат помещается в \texttt{ArraySample} (\texttt{NumPy}-совместная обёртка).
\end{enumerate}
Стратегию можно переопределить для имитационного моделирования или специализированных процедур
(например, стратифицированная или квазислучайная выборка).

\subsection{Кэширование: политика и ключи}

Кэширование реализовано внутри \texttt{DefaultComputationStrategy} и прозрачно для клиента.
Рекомендуется формировать ключ кэша как хеш неизменяемого представления
\{тип и параметры распределения, целевая характеристика, входные данные, опции, выбранный маршрут/метод\}.
Такой ключ обеспечивает корректность при наличии альтернативных методов между теми же узлами.
Иммутабельность экземпляров распределений упрощает инвалидацию: глобальная очистка выполняется только
при смене стратегии или конфигурации.

\subsection{Точки расширения и совместимость}

Архитектура поддерживает расширение без модификации существующих интерфейсов:
\begin{itemize}
  \item \textbf{Стратегии.} Замена \texttt{SamplingStrategy} и/или \texttt{ComputationStrategy}
        позволяет настроить маршрутизацию, кэш и интерпретацию \texttt{**options}.
  \item \textbf{Методы.} Добавление новых \texttt{ComputationMethod}/\texttt{FittedComputationMethod}
        вводит альтернативные рёбра графа. Во избежание конфликтов не рекомендуется использовать
        зарезервированное имя \texttt{DEFAULT\_COMPUTATION\_KEY}.
  \item \textbf{Аналитические якоря.} Расширение набора \texttt{AnalyticalComputation} для конкретного
        распределения упрощает и ускоряет вычисления, сокращая длину маршрутов.
  \item \textbf{Реестр.} Операции \texttt{register\_definitive}, \texttt{add\_bidirectional\_conversion},
        \texttt{add\_conversion} позволяют безопасно наращивать граф с сохранением инвариантов.
\end{itemize}

\subsection{Ошибки и диагностика}

При нарушении инвариантов реестра (например, попытка зарегистрировать второй исходный definitive-узел в
пустом графе) выбрасывается исключение конфигурации. Для диагностики полезны:
\begin{enumerate}
  \item трассировка выбранного маршрута (последовательность узлов и имён методов);
  \item отметка источника результата (аналитика/кэш/маршрут);
  \item контроль версий для пользовательских методов, добавленных в реестр.
\end{enumerate}
